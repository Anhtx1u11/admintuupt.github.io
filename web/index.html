<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ki·ªÉm tra nh√≥m 1</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: url('https://images.unsplash.com/photo-1519389950473-47ba0277781c?auto=format&fit=crop&w=1740&q=80') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 20px;
    }
    .container {
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      max-width: 700px;
      margin: auto;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      position: relative;
    }
    h1, h2 {
      text-align: center;
      color: #2c3e50;
    }
    #timer {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 18px;
      color: #e74c3c;
      font-weight: bold;
    }
    button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 16px;
    }
  </style>
</head>
<body>

<div class="container">
  <div id="timer" style="display: none;">‚è≥ Th·ªùi gian c√≤n l·∫°i: 60 gi√¢y</div>

  <h1>‚úàÔ∏è Tr·∫£ L·ªùi Vui Nh·∫≠n Qu√†</h1>

  <div id="nameInput">
    <h2>Nh·∫≠p h·ªç v√† t√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu</h2>
    <input type="text" id="fullName" placeholder="Nh·∫≠p h·ªç t√™n..." required>
    <button onclick="submitName()">G·ª≠i t√™n</button>
  </div>

  <div id="waitingMessage" style="display:none;"></div>

  <form id="quizForm" style="display:none;">
    <h2>C√¢u h·ªèi tr·∫Øc nghi·ªám</h2>

    <p>1. Th·ªß ƒë√¥ c·ªßa Vi·ªát Nam l√†?</p>
    <input type="radio" name="q1" value="H√† N·ªôi"> H√† N·ªôi<br>
    <input type="radio" name="q1" value="H·ªì Ch√≠ Minh"> H·ªì Ch√≠ Minh<br>
    <input type="radio" name="q1" value="ƒê√† N·∫µng"> ƒê√† N·∫µng<br>

    <p>2. 5 + 7 = ?</p>
    <input type="radio" name="q2" value="10"> 10<br>
    <input type="radio" name="q2" value="12"> 12<br>
    <input type="radio" name="q2" value="14"> 14<br>

    <p>3. M√†u c·ªßa b·∫ßu tr·ªùi th∆∞·ªùng l√†?</p>
    <input type="radio" name="q3" value="Xanh"> Xanh<br>
    <input type="radio" name="q3" value="ƒê·ªè"> ƒê·ªè<br>
    <input type="radio" name="q3" value="V√†ng"> V√†ng<br>

    <button type="button" onclick="submitQuiz()">N·ªôp b√†i</button>
  </form>

  <div id="result" style="display:none;"></div>
</div>

<script>
  let fullName = "";
  let checkingInterval;
  let started = false;
  let lastUpdateId = 0;
  let countdown;
  let startTime;
  let blocked = false;
  let stopped = false;

  const BOT_TOKEN = '7810588881:AAFp0FLW10ZB2QYlbHgEqhh6lDBM4jDHxT4'; 
  const CHAT_ID = '5293126208'; 

  async function submitName() {
    fullName = document.getElementById('fullName').value.trim();
    if (fullName === "") {
      alert("Vui l√≤ng nh·∫≠p h·ªç t√™n!");
      return;
    }

    if (blocked) {
      document.getElementById('nameInput').style.display = 'none';
      document.getElementById('waitingMessage').style.display = 'block';
      document.getElementById('waitingMessage').innerHTML = `<h2>üö´ B√†i ki·ªÉm tra ƒë√£ b·ªã kh√≥a. Kh√¥ng th·ªÉ tham gia.</h2>`;
      return;
    }

    document.getElementById('nameInput').style.display = 'none';
    document.getElementById('waitingMessage').style.display = 'block';
    document.getElementById('waitingMessage').innerHTML = `<h2>‚è≥ ${fullName} ƒëang ch·ªù admin k√≠ch ho·∫°t...</h2>`;

    await notifyAdmin(fullName);
    await recordLastUpdateId();
    startPollingTelegram();
  }

  async function notifyAdmin(name) {
    const message = `üì¢ Th√≠ sinh ${name} ƒëang ch·ªù thi!`;
    const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${CHAT_ID}&text=${encodeURIComponent(message)}`;
    await fetch(url);
  }

  async function recordLastUpdateId() {
    const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getUpdates`);
    const data = await res.json();
    const updates = data.result || [];
    if (updates.length > 0) {
      lastUpdateId = updates[updates.length - 1].update_id;
    }
  }

  function startPollingTelegram() {
    checkingInterval = setInterval(async () => {
      try {
        const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getUpdates?offset=${lastUpdateId + 1}`);
        const data = await res.json();
        const updates = data.result || [];

        if (updates.length > 0) {
          for (const update of updates) {
            lastUpdateId = update.update_id;

            if (update.message &&
                update.message.chat.id == CHAT_ID &&
                update.message.text) {

              const text = update.message.text.toLowerCase();

              if (text.includes("/lambai") && !started && !stopped) {
                startQuiz();
              }

              if (text.includes("/block")) {
                blocked = true;
                console.log("ƒê√£ nh·∫≠n l·ªánh /block");
              }

              if (text.includes("/dung")) {
                stopped = true;
                stopQuizImmediately();
                console.log("ƒê√£ nh·∫≠n l·ªánh /dung");
              }

              if (text.includes("/reset")) {
                resetAll();
                console.log("ƒê√£ nh·∫≠n l·ªánh /reset");
              }
            }
          }
        }
      } catch (error) {
        console.error("L·ªói polling:", error);
      }
    }, 300);
  }

  function startQuiz() {
    started = true;
    document.getElementById('waitingMessage').style.display = 'none';
    document.getElementById('quizForm').style.display = 'block';
    document.getElementById('timer').style.display = 'block';
    startTimer(60);
    startTime = new Date();
  }

  function startTimer(seconds) {
    const timerElement = document.getElementById('timer');
    timerElement.innerText = `‚è≥ Th·ªùi gian c√≤n l·∫°i: ${seconds} gi√¢y`;
    countdown = setInterval(() => {
      seconds--;
      timerElement.innerText = `‚è≥ Th·ªùi gian c√≤n l·∫°i: ${seconds} gi√¢y`;
      if (seconds <= 0) {
        clearInterval(countdown);
        submitQuiz();
      }
    }, 1000);
  }

  async function submitQuiz() {
    clearInterval(countdown);
    clearInterval(checkingInterval);

    const endTime = new Date();
    const timeTaken = Math.floor((endTime - startTime) / 1000);

    const correctAnswers = {
      q1: "H√† N·ªôi",
      q2: "12",
      q3: "Xanh"
    };

    let score = 0;
    for (let key in correctAnswers) {
      const selected = document.querySelector(`input[name="${key}"]:checked`);
      if (selected && selected.value === correctAnswers[key]) {
        score++;
      }
    }

    document.getElementById('quizForm').style.display = 'none';
    document.getElementById('timer').style.display = 'none';
    document.getElementById('result').style.display = 'block';
    document.getElementById('result').innerText = `‚úÖ ${fullName}\nƒêi·ªÉm: ${score}/3\nTh·ªùi gian: ${timeTaken} gi√¢y`;

    const message = `üìÑ K·∫øt qu·∫£: ${fullName}\nƒêi·ªÉm: ${score}/3\nTh·ªùi gian: ${timeTaken} gi√¢y`;
    const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${CHAT_ID}&text=${encodeURIComponent(message)}`;
    await fetch(url);
  }

  function stopQuizImmediately() {
    clearInterval(countdown);
    clearInterval(checkingInterval);

    document.getElementById('quizForm').style.display = 'none';
    document.getElementById('timer').style.display = 'none';
    document.getElementById('waitingMessage').style.display = 'block';
    document.getElementById('waitingMessage').innerHTML = `<h2>üö´ B√†i ki·ªÉm tra ƒë√£ b·ªã d·ª´ng b·ªüi admin.</h2>`;
  }

  function resetAll() {
    clearInterval(countdown);
    clearInterval(checkingInterval);

    fullName = "";
    started = false;
    blocked = false;
    stopped = false;

    document.getElementById('fullName').value = "";
    document.getElementById('nameInput').style.display = 'block';
    document.getElementById('waitingMessage').style.display = 'none';
    document.getElementById('quizForm').style.display = 'none';
    document.getElementById('result').style.display = 'none';
    document.getElementById('timer').style.display = 'none';

    recordLastUpdateId().then(() => {
      startPollingTelegram();
    });
  }
</script>

</body>
</html>
